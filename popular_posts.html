<!DOCTYPE html>
<html lang="ko">
<!-- í—¤ë“œ -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•™ê³¼ í† ë¡ ë°© - ì¸ê¸° ê¸€</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js"></script>
  <script type="module" src="/firebase-init.js"></script>
</head>
<!-- ë©”ì¸ -->

<body>
  <header class="main-header">
    <h1>ì¸ê¸° ê¸€ ëª©ë¡</h1>
    <nav class="main-nav">
      <ul>
        <li><a href="index.html">í™ˆìœ¼ë¡œ</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <section class="all-popular-posts">
      <h2>ğŸ”¥ì¸ê¸° ê¸€ğŸ”¥</h2>
      <button id="show-all-posts" class="ingi active">ì¶”ì²œ ìˆœ</button>
      <button id="show-popular-posts" class="ingi">ìµœì‹  ìˆœ</button>
      <ul id="all-popular-posts-list" class="post-list">
        <!-- ì¸ê¸° ê¸€ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ -->
      </ul>
      <div class="search-section">
        <input id="search-input" type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        <button id="search-button" class="search-btn">ê²€ìƒ‰</button>
      </div>
    </section>
  </main>
  <!-- í‘¸í„° -->
  <footer class="main-footer">
    <p>&copy; 2024 ë™ì˜ëŒ€í•™êµ í•™ê³¼í† ë¡ ë°©. All rights reserved.</p>
  </footer>

  <script type="module">
    import { db } from "/firebase-init.js";
    import { ref, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // ëª¨ë“  ì¸ê¸° ê¸€ ë°ì´í„°ë¥¼ ì €ì¥í•  ì „ì—­ ë°°ì—´
    let allPopularPosts = [];

    // í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì´ˆê¸°í™” í•¨ìˆ˜
    document.addEventListener("DOMContentLoaded", () => {
      // Firebaseì—ì„œ ì¸ê¸° ê¸€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤
      loadAllPopularPosts();

      // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì •
      document.getElementById("search-button").addEventListener("click", () => {
        // ë°ì´í„°ê°€ ë¡œë“œëœ ìƒíƒœì—ì„œë§Œ ê²€ìƒ‰ ê¸°ëŠ¥ ë™ì‘
        if (allPopularPosts.length > 0) {
          const searchTerm = document.getElementById("search-input").value.trim();
          if (searchTerm) {
            filterPostsBySearch(searchTerm);
          }
        } else {
          console.error("Posts are not loaded yet!"); // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
        }
      });

      // Enter í‚¤ë¡œ ê²€ìƒ‰ íŠ¸ë¦¬ê±°
      document.getElementById("search-input").addEventListener("keyup", (event) => {
        if (event.key === "Enter") {
          document.getElementById("search-button").click();
        }
      });

      // ì¶”ì²œ ìˆœ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.getElementById("show-all-posts").addEventListener("click", () => {
        renderAllPopularPosts(allPopularPosts, "likes"); // ì¶”ì²œ ìˆ˜ ê¸°ì¤€ ì •ë ¬
        setActiveButton("show-all-posts"); // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      });

      // ìµœì‹  ìˆœ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.getElementById("show-popular-posts").addEventListener("click", () => {
        renderAllPopularPosts(allPopularPosts, "date"); // ìµœì‹ ìˆœ ì •ë ¬
        setActiveButton("show-popular-posts"); // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
      });
    });

    // Firebaseì—ì„œ ëª¨ë“  ì¸ê¸° ê¸€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
    async function loadAllPopularPosts() {
      try {
        const postsRef = ref(db, "posts"); // ë°ì´í„°ë² ì´ìŠ¤ì˜ 'posts' ê²½ë¡œ ì°¸ì¡°
        const snapshot = await get(postsRef); // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

        if (snapshot.exists()) {
          const posts = snapshot.val();
          allPopularPosts = []; // ê¸°ì¡´ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”

          // í•™ê³¼ë³„ë¡œ ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©° ì¸ê¸° ê¸€ë§Œ í•„í„°ë§
          Object.keys(posts).forEach((department) => {
            Object.keys(posts[department]).forEach((postId) => {
              const post = posts[department][postId];
              if (post.likes && post.likes >= 10) {
                allPopularPosts.push({
                  department, // í•™ê³¼ ì´ë¦„
                  id: postId, // ê²Œì‹œê¸€ ID
                  title: post.title, // ì œëª©
                  author: post.author, // ì‘ì„±ì
                  authorIP: post.authorIP || "ì•Œ ìˆ˜ ì—†ìŒ", // ì‘ì„±ì IP (ê¸°ë³¸ê°’ ì„¤ì •)
                  date: post.date, // ì‘ì„±ì¼
                  views: post.views || 0, // ì¡°íšŒìˆ˜ (ê¸°ë³¸ê°’ 0)
                  likes: post.likes, // ì¶”ì²œ ìˆ˜
                  content: post.content || "", // ë‚´ìš© (ê¸°ë³¸ê°’ ë¹ˆ ë¬¸ìì—´)
                  commentCount: post.comments ? Object.keys(post.comments).length : 0, // ëŒ“ê¸€ ê°œìˆ˜
                });
              }
            });
          });

          // ê¸°ë³¸ì ìœ¼ë¡œ ì¶”ì²œ ìˆœìœ¼ë¡œ ì¸ê¸° ê¸€ ë Œë”ë§
          renderAllPopularPosts(allPopularPosts, "likes");
        } else {
          console.log("No posts available."); // ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
          renderAllPopularPosts([], "likes"); // ë¹ˆ ë°ì´í„°ë¡œ ë Œë”ë§
        }
      } catch (error) {
        console.error("Error loading all popular posts:", error); // ì—ëŸ¬ í•¸ë“¤ë§
      }
    }

    // ì¸ê¸° ê¸€ ëª©ë¡ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
    function renderAllPopularPosts(posts, sortBy) {
      const postsList = document.getElementById("all-popular-posts-list"); // HTML ìš”ì†Œ ì°¸ì¡°
      postsList.innerHTML = ""; // ê¸°ì¡´ ë‚´ìš©ì„ ì´ˆê¸°í™”

      if (posts.length === 0) {
        postsList.innerHTML = `<li class="post-item">ì¸ê¸° ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>`; // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
        return;
      }

      // ì •ë ¬ ì¡°ê±´ì— ë”°ë¼ ë°ì´í„° ì •ë ¬
      if (sortBy === "likes") {
        posts.sort((a, b) => b.likes - a.likes); // ì¶”ì²œ ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
      } else if (sortBy === "date") {
        posts.sort((a, b) => new Date(b.date) - new Date(a.date)); // ìµœì‹ ìˆœ
      }

      // ì •ë ¬ëœ ë°ì´í„°ë¥¼ HTML ìš”ì†Œë¡œ ë³€í™˜í•˜ì—¬ ì¶”ê°€
      postsList.innerHTML = posts
        .map(({ department, id, title, author, authorIP, date, views, likes, commentCount }) => {
          const postDate = new Date(date);
          const today = new Date();
          let formattedDate;

          // ë‚ ì§œ í˜•ì‹ ì§€ì • (ì˜¤ëŠ˜ ì‘ì„±ëœ ê¸€ì¸ì§€ ì—¬ë¶€ í™•ì¸)
          if (postDate.toDateString() === today.toDateString()) {
            const hours = String(postDate.getHours()).padStart(2, "0");
            const minutes = String(postDate.getMinutes()).padStart(2, "0");
            formattedDate = `${hours}:${minutes}`;
          } else {
            const month = String(postDate.getMonth() + 1).padStart(2, "0");
            const day = String(postDate.getDate()).padStart(2, "0");
            formattedDate = `${month}.${day}`;
          }

          const commentDisplay = commentCount > 0 ? ` [${commentCount}]` : ""; // ëŒ“ê¸€ í‘œì‹œ

          return `
                    <li class="post-item">
                      <a href="post_detail.html?dept=
                      ${encodeURIComponent(department)}&id=${encodeURIComponent(id)}" class="post-title">
                        <span class="popular-tag" style="color:red">[${department}] </span>
                        ${title}<span style='color:#004d99'>${commentDisplay}</span>
                      </a>
                      <div class="post-meta">
                        <span>${author}</span>
                        <span>(${authorIP}) |</span>
                        <span>${formattedDate} |</span>
                        <span>ì¡°íšŒ ${views} |</span>
                        <span>ì¶”ì²œ ${likes}</span>
                      </div>
                    </li>
                `;
        })
        .join("");
    }

    // ê²€ìƒ‰ì–´ë¡œ ê²Œì‹œê¸€ í•„í„°ë§
    function filterPostsBySearch(searchTerm) {
      const filteredPosts = allPopularPosts.filter((post) =>
        post.title.includes(searchTerm) || // ì œëª©ì— ê²€ìƒ‰ì–´ í¬í•¨ ì—¬ë¶€
        post.author.includes(searchTerm) || // ì‘ì„±ìì— ê²€ìƒ‰ì–´ í¬í•¨ ì—¬ë¶€
        post.content.includes(searchTerm) // ë‚´ìš©ì— ê²€ìƒ‰ì–´ í¬í•¨ ì—¬ë¶€
      );
      renderAllPopularPosts(filteredPosts, "likes"); // í•„í„°ë§ëœ ê²°ê³¼ ë Œë”ë§
    }

    // ë²„íŠ¼ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸
    function setActiveButton(activeId) {
      document.getElementById("show-all-posts").classList.remove("active");
      document.getElementById("show-popular-posts").classList.remove("active");
      document.getElementById(activeId).classList.add("active");
    }
  </script>

</body>

</html>