<!DOCTYPE html>
<html lang="ko">
<!-- 헤드 -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>학과 토론방 - 인기 글</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js"></script>
  <script type="module" src="/firebase-init.js"></script>
</head>
<!-- 메인 -->

<body>
  <header class="main-header">
    <h1>인기 글 목록</h1>
    <nav class="main-nav">
      <ul>
        <li><a href="index.html">홈으로</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <section class="all-popular-posts">
      <h2>🔥인기 글🔥</h2>
      <button id="show-all-posts" class="ingi active">추천 순</button>
      <button id="show-popular-posts" class="ingi">최신 순</button>
      <ul id="all-popular-posts-list" class="post-list">
        <!-- 인기 글이 여기에 동적으로 추가 -->
      </ul>
      <div class="search-section">
        <input id="search-input" type="text" class="search-input" placeholder="검색어를 입력하세요" />
        <button id="search-button" class="search-btn">검색</button>
      </div>
    </section>
  </main>
  <!-- 푸터 -->
  <footer class="main-footer">
    <p>&copy; 2024 동의대학교 학과토론방. All rights reserved.</p>
  </footer>

  <script type="module">
    import { db } from "/firebase-init.js";
    import { ref, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // 모든 인기 글 데이터를 저장할 전역 배열
    let allPopularPosts = [];

    // 페이지가 로드되었을 때 실행되는 초기화 함수
    document.addEventListener("DOMContentLoaded", () => {
      // Firebase에서 인기 글 데이터를 불러온다
      loadAllPopularPosts();

      // 검색 버튼 클릭 이벤트 설정
      document.getElementById("search-button").addEventListener("click", () => {
        // 데이터가 로드된 상태에서만 검색 기능 동작
        if (allPopularPosts.length > 0) {
          const searchTerm = document.getElementById("search-input").value.trim();
          if (searchTerm) {
            filterPostsBySearch(searchTerm);
          }
        } else {
          console.error("Posts are not loaded yet!"); // 데이터가 없을 때 에러 로그 출력
        }
      });

      // Enter 키로 검색 트리거
      document.getElementById("search-input").addEventListener("keyup", (event) => {
        if (event.key === "Enter") {
          document.getElementById("search-button").click();
        }
      });

      // 추천 순 버튼 클릭 이벤트
      document.getElementById("show-all-posts").addEventListener("click", () => {
        renderAllPopularPosts(allPopularPosts, "likes"); // 추천 수 기준 정렬
        setActiveButton("show-all-posts"); // 버튼 스타일 업데이트
      });

      // 최신 순 버튼 클릭 이벤트
      document.getElementById("show-popular-posts").addEventListener("click", () => {
        renderAllPopularPosts(allPopularPosts, "date"); // 최신순 정렬
        setActiveButton("show-popular-posts"); // 버튼 스타일 업데이트
      });
    });

    // Firebase에서 모든 인기 글 데이터를 불러오는 함수
    async function loadAllPopularPosts() {
      try {
        const postsRef = ref(db, "posts"); // 데이터베이스의 'posts' 경로 참조
        const snapshot = await get(postsRef); // 데이터 가져오기

        if (snapshot.exists()) {
          const posts = snapshot.val();
          allPopularPosts = []; // 기존 데이터를 초기화

          // 학과별로 데이터를 순회하며 인기 글만 필터링
          Object.keys(posts).forEach((department) => {
            Object.keys(posts[department]).forEach((postId) => {
              const post = posts[department][postId];
              if (post.likes && post.likes >= 10) {
                allPopularPosts.push({
                  department, // 학과 이름
                  id: postId, // 게시글 ID
                  title: post.title, // 제목
                  author: post.author, // 작성자
                  authorIP: post.authorIP || "알 수 없음", // 작성자 IP (기본값 설정)
                  date: post.date, // 작성일
                  views: post.views || 0, // 조회수 (기본값 0)
                  likes: post.likes, // 추천 수
                  content: post.content || "", // 내용 (기본값 빈 문자열)
                  commentCount: post.comments ? Object.keys(post.comments).length : 0, // 댓글 개수
                });
              }
            });
          });

          // 기본적으로 추천 순으로 인기 글 렌더링
          renderAllPopularPosts(allPopularPosts, "likes");
        } else {
          console.log("No posts available."); // 데이터가 없는 경우
          renderAllPopularPosts([], "likes"); // 빈 데이터로 렌더링
        }
      } catch (error) {
        console.error("Error loading all popular posts:", error); // 에러 핸들링
      }
    }

    // 인기 글 목록을 렌더링하는 함수
    function renderAllPopularPosts(posts, sortBy) {
      const postsList = document.getElementById("all-popular-posts-list"); // HTML 요소 참조
      postsList.innerHTML = ""; // 기존 내용을 초기화

      if (posts.length === 0) {
        postsList.innerHTML = `<li class="post-item">인기 글이 없습니다.</li>`; // 데이터가 없을 때 메시지 표시
        return;
      }

      // 정렬 조건에 따라 데이터 정렬
      if (sortBy === "likes") {
        posts.sort((a, b) => b.likes - a.likes); // 추천 수 내림차순
      } else if (sortBy === "date") {
        posts.sort((a, b) => new Date(b.date) - new Date(a.date)); // 최신순
      }

      // 정렬된 데이터를 HTML 요소로 변환하여 추가
      postsList.innerHTML = posts
        .map(({ department, id, title, author, authorIP, date, views, likes, commentCount }) => {
          const postDate = new Date(date);
          const today = new Date();
          let formattedDate;

          // 날짜 형식 지정 (오늘 작성된 글인지 여부 확인)
          if (postDate.toDateString() === today.toDateString()) {
            const hours = String(postDate.getHours()).padStart(2, "0");
            const minutes = String(postDate.getMinutes()).padStart(2, "0");
            formattedDate = `${hours}:${minutes}`;
          } else {
            const month = String(postDate.getMonth() + 1).padStart(2, "0");
            const day = String(postDate.getDate()).padStart(2, "0");
            formattedDate = `${month}.${day}`;
          }

          const commentDisplay = commentCount > 0 ? ` [${commentCount}]` : ""; // 댓글 표시

          return `
                    <li class="post-item">
                      <a href="post_detail.html?dept=
                      ${encodeURIComponent(department)}&id=${encodeURIComponent(id)}" class="post-title">
                        <span class="popular-tag" style="color:red">[${department}] </span>
                        ${title}<span style='color:#004d99'>${commentDisplay}</span>
                      </a>
                      <div class="post-meta">
                        <span>${author}</span>
                        <span>(${authorIP}) |</span>
                        <span>${formattedDate} |</span>
                        <span>조회 ${views} |</span>
                        <span>추천 ${likes}</span>
                      </div>
                    </li>
                `;
        })
        .join("");
    }

    // 검색어로 게시글 필터링
    function filterPostsBySearch(searchTerm) {
      const filteredPosts = allPopularPosts.filter((post) =>
        post.title.includes(searchTerm) || // 제목에 검색어 포함 여부
        post.author.includes(searchTerm) || // 작성자에 검색어 포함 여부
        post.content.includes(searchTerm) // 내용에 검색어 포함 여부
      );
      renderAllPopularPosts(filteredPosts, "likes"); // 필터링된 결과 렌더링
    }

    // 버튼 상태를 업데이트
    function setActiveButton(activeId) {
      document.getElementById("show-all-posts").classList.remove("active");
      document.getElementById("show-popular-posts").classList.remove("active");
      document.getElementById(activeId).classList.add("active");
    }
  </script>

</body>

</html>