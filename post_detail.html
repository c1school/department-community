<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">게시글 상세보기</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js"></script>
  <script type="module" src="/firebase-init.js"></script>
</head>

<body>
  <header class="main-header">
    <h1 id="department-title">게시글 상세보기</h1>
    <nav class="main-nav">
      <ul>
        <li><a href="#" id="back-to-list">목록으로</a></li>
      </ul>
    </nav>
  </header>

  <main class="main-content">
    <section class="post-detail">
      <h2 id="post-title"></h2>
      <p class="meta">
        작성자: <span id="post-author"></span> |
        작성일: <span id="post-date"></span> |
        조회수: <span id="post-views"></span>
        <button class="delete-post-btn" id="delete-post-btn">삭제</button>

      </p>

      <div id="post-content" class="content"></div>
    </section>

    <section class="comments">
      <h3>댓글</h3>
      <ul id="comment-list">
        <!-- 동적으로 댓글 추가 -->
      </ul>
      <form id="comment-form">
        <textarea id="comment-input" rows="3" placeholder="댓글을 입력하세요..." required></textarea>
        <button type="submit" class="btn-submit">댓글 작성</button>
      </form>
    </section>
  </main>

  <footer class="main-footer">
    <p>&copy; 2024 동의대학교 학과토론방. All rights reserved.</p>
  </footer>

  <script type="module">
    import { db } from "/firebase-init.js";
    import { ref, get, update, remove, push, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    
    // URL에서 학과와 게시글 ID 가져오기
    const urlParams = new URLSearchParams(window.location.search);
    const department = urlParams.get('dept');
    const postId = urlParams.get('id');
    
    if (!department || !postId) {
      document.body.innerHTML = "<p>잘못된 접근입니다. 글 정보를 확인할 수 없습니다.</p>";
      throw new Error("글 정보가 누락되었습니다.");
    }
    
    // 게시글 데이터 로드
    const postRef = ref(db, `posts/${department}/${postId}`);
    get(postRef)
      .then((snapshot) => {
        if (snapshot.exists()) {
          const post = snapshot.val();
    
          // 페이지에 게시글 데이터 표시
          document.getElementById("page-title").innerText = `${post.title} - 상세보기`;
          document.getElementById("department-title").innerText = `${department} 토론방`;
          document.getElementById("post-title").innerText = post.title;
          document.getElementById("post-author").innerText = post.author;
          document.getElementById("post-date").innerText = new Date(post.date).toLocaleString();
          document.getElementById("post-content").innerHTML = post.content || "내용이 없습니다.";
          document.getElementById("post-views").innerText = post.views || 0;
    
          // 조회수 증가
          const newViews = (post.views || 0) + 1;
          update(postRef, { views: newViews });
        } else {
          document.body.innerHTML = "<p>존재하지 않는 게시글입니다.</p>";
        }
      })
      .catch((error) => {
        console.error("게시글 로드 중 오류 발생:", error);
        document.body.innerHTML = "<p>게시글을 불러오는 중 오류가 발생했습니다.</p>";
      });
    
    // 댓글 데이터 로드
    const commentsRef = ref(db, `posts/${department}/${postId}/comments`);
    onValue(commentsRef, (snapshot) => {
      const commentList = document.getElementById("comment-list");
      if (snapshot.exists()) {
        const comments = snapshot.val();
        commentList.innerHTML = Object.values(comments)
          .map((comment) => `<li>${comment}</li>`)
          .join("");
      } else {
        commentList.innerHTML = "<li>댓글이 없습니다. 첫 번째 댓글을 작성해보세요!</li>";
      }
    });
    
    // 댓글 작성
    const commentForm = document.getElementById("comment-form");
    commentForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const commentInput = document.getElementById("comment-input");
      const newComment = commentInput.value.trim();
    
      if (newComment) {
        push(commentsRef, newComment)
          .then(() => {
            commentInput.value = "";
            alert("댓글이 작성되었습니다.");
          })
          .catch((error) => {
            console.error("댓글 작성 중 오류 발생:", error);
            alert("댓글 작성 중 문제가 발생했습니다.");
          });
      }
    });
    
    // 목록으로 돌아가기
    document.getElementById("back-to-list").addEventListener("click", () => {
      window.location.href = `department_discussion.html?dept=${encodeURIComponent(department)}`;
    });
    
    // 게시글 삭제
    document.getElementById('delete-post-btn').addEventListener('click', () => {
      const userPassword = prompt("게시글 비밀번호를 입력하세요:");
      if (!userPassword) return;
    
      get(postRef).then((snapshot) => {
        if (snapshot.exists()) {
          const post = snapshot.val();
    
          // 비밀번호 확인
          if (post.password === userPassword) {
            remove(postRef)
              .then(() => {
                alert("게시글이 삭제되었습니다.");
                window.location.href = `department_discussion.html?dept=${encodeURIComponent(department)}`;
              })
              .catch((error) => {
                console.error("게시글 삭제 중 오류 발생:", error);
                alert("게시글 삭제 중 오류가 발생했습니다.");
              });
          } else {
            alert("비밀번호가 틀렸습니다. 다시 시도해주세요.");
          }
        } else {
          alert("존재하지 않는 게시글입니다.");
        }
      });
    });
    </script>
    
</body>

</html>