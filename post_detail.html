<!DOCTYPE html>
<html lang="ko">
<!-- 헤드 -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">학과 토론방 - `${department}`</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js"></script>
  <script type="module" src="/firebase-init.js"></script>
</head>

<body>
  <!-- 헤더 -->
  <header class="main-header">
    <h1 id="department-title">토론 방</h1>
    <nav class="main-nav">
      <ul>
        <li><a href="#" id="back-to-list">목록으로</a></li>
      </ul>
    </nav>
  </header>
  <!-- 메인 -->
  <main class="main-content">
    <!-- 게시글 내용 섹션 -->
    <section class="post-detail">
      <h2 id="post-title"></h2>
      <p class="meta">
        작성자: <span id="post-author"></span> |
        작성일: <span id="post-date"></span> |
        조회수: <span id="post-views"></span> |
        추천수: <span id="post-likes"></span>
      </p>
      <div id="post-content" class="content"></div>
      <button class="like-post-btn" id="like-post-btn">게시글 추천</button>
      <button class="delete-post-btn" id="delete-post-btn">게시글 삭제</button>
    </section>
    <!-- 댓글 섹션 -->
    <section class="comments">
      <h3>댓글</h3>
      <ul id="comment-list">
        <!-- 동적으로 댓글 추가 -->
      </ul>
      <form id="comment-form">
        <div class="input-group">
          <label for="comment-name"></label>
          <input type="text" id="comment-name" placeholder="닉네임" required />
          <label for="comment-password"></label>
          <input type="password" id="comment-password" placeholder="비밀번호" required />
          <textarea id="comment-input" rows="3" placeholder="
          타인의 권리를 침해하거나 명예를 훼손하는 댓글은
          운영원칙 및 관련 법률에 의해 제재를 받을 수 있습니다." required></textarea>
          <p class="comment-guideline">
          </p>
        </div>
        <button type="submit" class="btn-submit">등록</button>
      </form>
    </section>
  </main>

  <footer class="main-footer">
    <p>&copy; 2024 동의대학교 학과토론방. All rights reserved.</p>
  </footer>

  <script type="module">
    import { db } from "/firebase-init.js";
    import { ref, get, update, remove, push, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // URL에서 학과와 게시글 ID를 가져오는 부분
    const urlParams = new URLSearchParams(window.location.search); // URL의 쿼리 문자열을 분석하기 위한 객체 생성
    const department = urlParams.get('dept'); // 'dept'라는 키로 학과 정보 가져옴
    const postId = urlParams.get('id'); // 'id'라는 키로 게시글 ID 가져옴

    // 페이지 제목을 설정함
    const pageTitle = document.getElementById("page-title"); // 제목 엘리먼트를 가져옴
    pageTitle.textContent = `학과 토론방 - ${department}`; // 학과명을 포함한 페이지 제목을 설정

    // 학과나 게시글 ID가 없는 경우, 에러 메시지를 출력하고 실행을 중단함
    if (!department || !postId) {
      document.body.innerHTML = "<p>잘못된 접근입니다. 글 정보를 확인할 수 없습니다.</p>"; // 사용자에게 잘못된 접근임을 알림
      throw new Error("글 정보가 누락되었습니다."); // 에러를 발생시켜 코드 실행 중단
    }

    // 특정 게시글 데이터를 가져오는 부분
    const postRef = ref(db, `posts/${department}/${postId}`); // Firebase 데이터베이스의 해당 게시글 경로를 참조함
    get(postRef)
      .then((snapshot) => { // 데이터를 성공적으로 가져온 경우
        if (snapshot.exists()) { // 게시글 데이터가 존재하는지 확인
          const post = snapshot.val(); // 게시글 데이터를 가져옴
          const likes = post.likes || 0; // 'likes'가 없으면 기본값 0으로 설정함

          // 게시글 데이터를 페이지에 표시
          document.getElementById("page-title").innerText = `${post.title} - 상세보기`; // 페이지 제목을 게시글 제목으로 설정
          document.getElementById("department-title").innerText = `${department} 토론방`; // 학과명 표시
          document.getElementById("post-title").innerText = post.title; // 게시글 제목 표시
          document.getElementById("post-author").innerText = `${post.author} (${post.authorIP})`; // 작성자와 IP 주소 표시
          document.getElementById("post-date").innerText = new Date(post.date).toLocaleString(); // 날짜를 로컬 시간 형식으로 표시
          document.getElementById("post-content").innerHTML = post.content || "내용이 없습니다."; // 게시글 내용을 표시
          document.getElementById("post-views").innerText = post.views || 0; // 조회수 표시
          document.getElementById("post-likes").innerText = likes || 0; // 추천 수 표시

          // 비동기 함수로 조회수 중복 체크 및 증가
          (async () => {
            try {
              // 사용자 IP 주소 가져오기
              let userIP = "unknown"; // 기본값 설정
              try {
                const response = await fetch("https://api.ipify.org?format=json"); // IP 주소를 가져오기 위한 API 호출
                const data = await response.json();
                userIP = data.ip.replace(/\./g, "_"); // IP 주소의 점(.)을 언더바(_)로 변환
              } catch (error) {
                console.error("IP 주소를 가져오는 중 오류 발생:", error); // IP 가져오기 실패 시 에러 출력
              }

              // 조회수 중복 확인
              const viewsIPRef = ref(db, `posts/${department}/${postId}/viewsIP/${userIP}`); // IP 확인 경로 참조
              const viewsIPSnapshot = await get(viewsIPRef); // IP 정보 가져오기

              if (!viewsIPSnapshot.exists()) { // 조회한 적이 없는 경우
                const postSnapshot = await get(postRef); // 게시글 데이터를 가져옴
                if (postSnapshot.exists()) {
                  const post = postSnapshot.val();
                  const newViews = (post.views || 0) + 1; // 조회수 1 증가

                  await update(postRef, { views: newViews }); // 조회수 업데이트
                  await update(ref(db, `posts/${department}/${postId}/viewsIP`), {
                    [userIP]: true, // 조회한 IP 저장
                  });

                  document.getElementById("post-views").innerText = newViews; // 화면에 조회수 업데이트
                }
              } else {
                console.log("이미 조회한 IP입니다. 조회수를 증가시키지 않습니다."); // 중복 조회 차단
              }
            } catch (error) {
              console.error("조회수 처리 중 오류 발생:", error); // 조회수 처리 오류 출력
            }
          })();
        } else {
          document.body.innerHTML = "<p>존재하지 않는 게시글입니다.</p>"; // 게시글이 없는 경우 메시지 표시
        }
      })
      .catch((error) => { // 데이터 가져오기 실패 시 처리
        console.error("게시글 로드 중 오류 발생:", error);
        document.body.innerHTML = "<p>게시글을 불러오는 중 오류가 발생했습니다.</p>";
      });

    // 댓글 데이터를 실시간으로 가져오는 부분
    const commentsRef = ref(db, `posts/${department}/${postId}/comments`); // 댓글 경로 참조
    onValue(commentsRef, (snapshot) => { // 실시간 데이터 이벤트 핸들러
      const commentList = document.getElementById("comment-list"); // 댓글 리스트 엘리먼트를 가져옴
      if (snapshot.exists()) { // 댓글 데이터가 존재하는 경우
        const comments = snapshot.val(); // 댓글 데이터를 가져옴
        commentList.innerHTML = Object.entries(comments)
          .map(([key, comment]) => `
                    <li>
                        <p><strong>${comment.name} (${comment.ip})</strong></p>
                        <p>${comment.text}</p>
                        <button class="delete-comment-btn" data-key="${key}">삭제</button>
                    </li>
                `)
          .join(""); // 댓글 데이터를 리스트로 표시

        // 댓글 삭제 버튼 이벤트 추가
        document.querySelectorAll(".delete-comment-btn").forEach((button) => {
          button.addEventListener("click", (e) => {
            const commentKey = e.target.dataset.key; // 삭제할 댓글의 키를 가져옴
            const userPassword = prompt("댓글 비밀번호를 입력하세요:"); // 비밀번호 입력 요청
            if (!userPassword) return;

            get(ref(db, `posts/${department}/${postId}/comments/${commentKey}`)).then((snapshot) => {
              if (snapshot.exists()) {
                const comment = snapshot.val();
                if (comment.password === userPassword) { // 비밀번호 확인
                  remove(ref(db, `posts/${department}/${postId}/comments/${commentKey}`))
                    .then(() => alert("댓글이 삭제되었습니다.")) // 성공 메시지
                    .catch((error) => console.error("댓글 삭제 중 오류 발생:", error)); // 에러 출력
                } else {
                  alert("비밀번호가 틀렸습니다."); // 비밀번호 불일치 메시지
                }
              }
            });
          });
        });
      }
    });

    // 댓글 작성 처리
    const commentForm = document.getElementById("comment-form"); // 댓글 작성 폼 엘리먼트를 가져옴
    commentForm.addEventListener("submit", async (e) => {
      e.preventDefault(); // 기본 제출 동작 막음
      const name = document.getElementById("comment-name").value.trim(); // 작성자 이름 가져옴
      const password = document.getElementById("comment-password").value.trim(); // 비밀번호 가져옴
      const text = document.getElementById("comment-input").value.trim(); // 댓글 내용 가져옴

      if (!name || !password || !text) { // 입력 필드가 비어있는 경우 처리
        alert("모든 필드를 입력하세요.");
        return;
      }

      // 사용자 IP 주소 가져오기
      let ip = "알 수 없음";
      try {
        const response = await fetch("https://api.ipify.org?format=json");
        const data = await response.json();
        ip = `${data.ip.split(".")[0]}.${data.ip.split(".")[1]}`; // IP 앞 두 자리만 표시
      } catch (error) {
        console.error("IP 주소를 가져오는 중 오류 발생:", error);
      }

      const newComment = { name, password, text, ip }; // 새로운 댓글 데이터 객체 생성

      push(commentsRef, newComment) // Firebase에 댓글 데이터 저장
        .then(() => {
          document.getElementById("comment-name").value = ""; // 입력 필드 초기화
          document.getElementById("comment-password").value = "";
          document.getElementById("comment-input").value = "";
          alert("댓글이 작성되었습니다."); // 성공 메시지
        })
        .catch((error) => {
          console.error("댓글 작성 중 오류 발생:", error); // 에러 출력
          alert("댓글 작성 중 문제가 발생했습니다.");
        });
    });

    // "목록으로 돌아가기" 버튼 동작 처리
    document.getElementById("back-to-list").addEventListener("click", () => {
      window.location.href = `department_discussion.html?dept=${encodeURIComponent(department)}`; // 학과 토론방 목록으로 이동
    });

    // 게시글 삭제 처리
    document.getElementById("delete-post-btn").addEventListener("click", () => {
      const userPassword = prompt("게시글 비밀번호를 입력하세요:"); // 비밀번호 입력 요청
      if (!userPassword) return;

      get(postRef).then((snapshot) => { // 게시글 데이터를 가져옴
        if (snapshot.exists()) {
          const post = snapshot.val();

          if (post.password === userPassword) { // 비밀번호 확인
            remove(postRef)
              .then(() => {
                alert("게시글이 삭제되었습니다."); // 성공 메시지
                window.location.href = `department_discussion.html?dept=${encodeURIComponent(department)}`; // 목록으로 이동
              })
              .catch((error) => {
                console.error("게시글 삭제 중 오류 발생:", error); // 에러 출력
                alert("게시글 삭제 중 오류가 발생했습니다.");
              });
          } else {
            alert("비밀번호가 틀렸습니다. 다시 시도해주세요."); // 비밀번호 불일치 메시지
          }
        } else {
          alert("존재하지 않는 게시글입니다."); // 게시글이 없는 경우 메시지 출력
        }
      });
    });

    // 게시글 추천 처리
    document.getElementById("like-post-btn").addEventListener("click", async () => {
      try {
        let userIP = "unknown"; // 기본값 설정
        try {
          const response = await fetch("https://api.ipify.org?format=json");
          const data = await response.json();
          userIP = data.ip.replace(/\./g, "_"); // IP 주소 포맷 변경
        } catch (error) {
          console.error("IP 주소를 가져오는 중 오류 발생:", error); // 에러 출력
        }

        const likesIPRef = ref(db, `posts/${department}/${postId}/likesIP/${userIP}`);
        const likesIPSnapshot = await get(likesIPRef);

        if (likesIPSnapshot.exists()) {
          alert("이미 추천하셨습니다."); // 중복 추천 차단
          return;
        }

        const postSnapshot = await get(postRef);
        if (postSnapshot.exists()) {
          const post = postSnapshot.val();
          const newLikes = (post.likes || 0) + 1;

          await update(postRef, { likes: newLikes });
          await update(ref(db, `posts/${department}/${postId}/likesIP`), {
            [userIP]: true,
          });

          document.getElementById("post-likes").innerText = newLikes;
          alert("추천이 완료되었습니다."); // 성공 메시지
        } else {
          alert("게시글 정보를 찾을 수 없습니다."); // 데이터 없음 메시지
        }
      } catch (error) {
        console.error("추천 처리 중 오류 발생:", error); // 에러 출력
        alert("추천 처리 중 문제가 발생했습니다.");
      }
    });
  </script>

</body>

</html>