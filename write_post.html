<!DOCTYPE html>
<html lang="ko">
<!-- 헤드 -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>학과 토론방 - 글 쓰기</title>
  <link rel="stylesheet" href="style.css">
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js"></script>
  <script type="module" src="/firebase-init.js"></script>
</head>

<body>
  <!-- 헤더 -->
  <header class="main-header">
    <h1 id="page-title">글쓰기</h1>
    <nav class="main-nav">
      <ul>
        <li><a href="index.html">홈으로</a></li>
      </ul>
    </nav>
  </header>
  <!-- 글 작성 섹션 -->
  <main class="main-content">
    <section class="write-post">
      <h2 id="department-title">글 작성</h2>
      <form id="post-form">
        <label for="post-title">제목:</label>
        <input type="text" id="post-title" name="post-title" required>

        <label for="post-content">내용:</label>
        <textarea id="post-content" name="post-content" rows="10" required></textarea>

        <label for="post-author">작성자:</label>
        <input type="text" id="post-author" name="post-author" required>

        <label for="post-password">비밀번호:</label>
        <input type="password" id="post-password" name="post-password" required autocomplete="current-password">

        <button type="submit" class="btn-write">작성 완료</button>
      </form>
    </section>
  </main>
  <!-- 푸터 -->
  <footer class="main-footer">
    <p>&copy; 2024 동의대학교 학과토론방. All rights reserved.</p>
  </footer>

  <script type="module">
    import { ref, push } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";
    import { db } from "/firebase-init.js"; 

    // URL에서 학과 정보를 가져오는 부분
    const urlParams = new URLSearchParams(window.location.search); 
    // URL 쿼리 문자열을 분석하기 위한 객체 생성
    const department = urlParams.get('dept') || '알 수 없는 학과';
    // 'dept' 파라미터로 학과 정보 가져오며, 없으면 기본값 '알 수 없는 학과' 사용
    document.getElementById('department-title').innerText = `${department} - 글 작성`;
    // 학과명과 글 작성 페이지 제목 설정

    // 폼 제출 이벤트 핸들러 설정
    const postForm = document.getElementById('post-form'); // 글 작성 폼 요소를 가져옴
    postForm.addEventListener('submit', (e) => { // 폼 제출 시 이벤트를 처리
      e.preventDefault(); // 기본 폼 제출 동작을 막음 (페이지 새로 고침 방지)
      savePost(); // savePost 함수 호출하여 게시글 저장 처리
    });

    // 게시글 저장 함수
    async function savePost() {
      try {
        // 입력 필드에서 데이터 가져오기
        const postTitle = document.getElementById('post-title').value.trim(); // 게시글 제목
        const postContent = document.getElementById('post-content').value.trim(); // 게시글 내용
        const postAuthor = document.getElementById('post-author').value.trim(); // 글쓴이 이름
        const postPassword = document.getElementById('post-password').value.trim(); // 비밀번호

        // 필수값 검증: 모든 필드가 입력되었는지 확인
        if (!postTitle || !postContent || !postAuthor || !postPassword) {
          alert('모든 필드를 입력해주세요.'); // 필드가 비어있으면 알림 메시지 출력
          return; // 입력이 올바르지 않으면 함수를 종료
        }

        // 사용자의 IP 주소를 가져오는 부분
        let ip = "알 수 없음"; // 기본값 설정
        try {
          const response = await fetch("https://api.ipify.org?format=json"); // IP 주소를 가져오는 API 호출
          const data = await response.json(); // 응답을 JSON 형태로 파싱
          ip = `${data.ip.split(".")[0]}.${data.ip.split(".")[1]}`; // IP 주소의 앞 두 자리만 사용
        } catch (error) {
          console.error("IP 주소를 가져오는 중 오류 발생:", error); // IP 주소 가져오는 중 오류 처리
        }

        // 새로운 게시글 객체 생성
        const newPost = {
          title: postTitle, // 게시글 제목
          content: postContent, // 게시글 내용
          author: postAuthor, // 작성자 이름
          authorIP: ip, // 작성자 IP
          password: postPassword, // 게시글 비밀번호
          date: new Date().toISOString(), // 게시글 작성일시 (ISO 8601 형식)
          views: 0, // 초기 조회수 0
          likes: 0, // 초기 추천 수 0
        };

        // Firebase에 게시글 저장
        const postsRef = ref(db, `posts/${department}`); // 해당 학과의 게시글 경로 참조
        await push(postsRef, newPost); // 새로운 게시글 데이터를 Firebase에 저장

        alert('게시글이 성공적으로 작성되었습니다.'); // 게시글 저장 성공 메시지
        window.location.href = `department_discussion.html?dept=${encodeURIComponent(department)}`;
        // 저장 후 게시글 목록 페이지로 리디렉션
      } catch (error) {
        console.error('게시글 저장 중 오류 발생:', error); // 오류가 발생한 경우 콘솔에 오류 출력
        alert('게시글 저장 중 문제가 발생했습니다. 다시 시도해주세요.'); // 오류 발생 시 사용자에게 알림
      }
    }
  </script>

</body>

</html>